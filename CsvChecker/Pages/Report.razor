@page "/report/{Token}"
@using System
@using CsvChecker.Library.Models
@using CvsChecker.Library.Helpers
@using CvsChecker.Library.Services.Interfaces
@inject IReportStore Store
@inject NavigationManager Nav

<div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
	@if (_result is null)
	{
		<div class="mx-auto max-w-2xl text-center">
			<div class="inline-flex items-center rounded-full border border-slate-200 bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">
				Report unavailable
			</div>

			<h1 class="mt-6 text-3xl font-extrabold tracking-tight text-slate-900 sm:text-4xl">
				Report not found
			</h1>

			<p class="mt-4 leading-relaxed text-slate-600">
				This can happen after an app restart because reports are stored in memory.
			</p>

			<div class="mt-8 flex justify-center gap-3">
				<a href="/"
				   class="inline-flex items-center justify-center rounded-xl bg-teal-600 px-5 py-3 font-semibold text-white shadow-lg shadow-teal-600/20 transition-all hover:bg-teal-700 active:scale-95">
					Upload another CSV
				</a>
			</div>
		</div>
	}
	else
	{
		<!-- Header -->
		<div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">
			<div>
				<div class="inline-flex items-center rounded-full border border-teal-100 bg-teal-50 px-3 py-1 text-xs font-semibold text-teal-700">
					Analysis complete
				</div>

				<h1 class="mt-4 text-3xl font-extrabold tracking-tight text-slate-900 sm:text-4xl">
					CSV Report
				</h1>

				<p class="mt-2 text-slate-600">
					<span class="font-semibold text-slate-800">@_result.FileName</span>
					<span class="text-slate-400">•</span>
					<span>@FormatBytes(_result.FileSizeBytes)</span>
				</p>
			</div>

		<div class="flex flex-col gap-3 sm:flex-row">
			@if (_result.Issues.Count > 0)
			{
				<a href="@($"/download/errors/{_result.Token}")"
				   class="inline-flex items-center justify-center gap-2 rounded-xl bg-teal-600 px-5 py-3 font-semibold text-white shadow-lg shadow-teal-600/20 transition-all hover:bg-teal-700 active:scale-95">
					<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
					</svg>
					Download errors.csv
				</a>
			}

			<a href="/"
			   class="@(_result.Issues.Count == 0
				? "inline-flex items-center justify-center px-5 py-3 rounded-xl bg-teal-600 text-white font-semibold shadow-lg shadow-teal-600/20 hover:bg-teal-700 transition-all active:scale-95"
				: "inline-flex items-center justify-center px-5 py-3 rounded-xl bg-white border border-slate-200 text-slate-700 font-semibold hover:border-teal-300 hover:text-teal-700 transition-all active:scale-95")">
			Analyze another CSV
		</a>
	</div>
</div>

	@if (expiresUtc is not null)
		{
			<p class="mt-2 flex items-center gap-1 text-sm text-gray-500">
				<span>⏱</span>
				Report expires at 6:20 PM (1 hour after upload).
			</p>
		}

		<!-- Summary cards -->
		<div class="mt-10 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
			<div class="rounded-2xl border border-slate-200/60 bg-slate-50 p-5">
				<div class="text-xs font-semibold text-slate-500">Encoding</div>
				<div class="mt-1 text-lg font-bold text-slate-900">@(_result.DetectedEncoding ?? "Unknown")</div>
			</div>

			<div class="rounded-2xl border border-slate-200/60 bg-slate-50 p-5">
				<div class="text-xs font-semibold text-slate-500">Delimiter</div>
				<div class="mt-1 text-lg font-bold text-slate-900">@(_result.DetectedDelimiter?.ToString() ?? "Unknown")</div>
			</div>

			<div class="rounded-2xl border border-slate-200/60 bg-slate-50 p-5">
				<div class="text-xs font-semibold text-slate-500">Rows (incl. header)</div>
				<div class="mt-1 text-lg font-bold text-slate-900">@(_result.RowCount?.ToString("N0") ?? "Unknown")</div>
			</div>

			<div class="rounded-2xl border border-slate-200/60 bg-slate-50 p-5">
				<div class="text-xs font-semibold text-slate-500">Columns</div>
				<div class="mt-1 text-lg font-bold text-slate-900">@(_result.ColumnCount?.ToString("N0") ?? "Unknown")</div>
			</div>
		</div>

		<div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
			<div class="rounded-2xl border border-slate-200 bg-white p-5">
				<div class="text-xs font-semibold text-slate-500">Newlines</div>
				<div class="mt-1 font-semibold text-slate-800">@(_result.DetectedNewline ?? "Unknown")</div>
			</div>

			<div class="rounded-2xl border border-slate-200 bg-white p-5">
				<div class="text-xs font-semibold text-slate-500">Issues</div>
				<div class="mt-1 flex items-center gap-2">
					<span class="text-xl font-extrabold text-slate-900">@_result.Issues.Count.ToString("N0")</span>
					<span class="text-sm text-slate-600">@(_result.Issues.Count == 1 ? "issue found" : "issues found")</span>
				</div>
			</div>
		</div>

		<!-- Filter pills -->
		<div class="mt-4 flex flex-wrap gap-2">
		@foreach (CsvIssueSeverity s in Enum.GetValues(typeof(CsvIssueSeverity)))
			{
				<button type="button"
						class="rounded-full border px-3 py-1 text-xs font-semibold transition-colors @(s == _filter
																														   	? "bg-slate-900 text-white border-slate-900"
																															: "bg-white text-slate-700 border-slate-200 hover:border-teal-300")"
				@onclick="@(() => ToggleFilter(s))">
			@s
		</button>
				}

			@if (_filter is not null)
			{
				<button type="button"
						class="rounded-full border border-slate-200 bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600"
						@onclick="ClearFilter">
					Clear
				</button>
			}
		</div>

		<!-- Issues -->
		<div class="mt-12">
			<div class="flex items-center justify-between gap-4">
				<h2 class="text-2xl font-extrabold tracking-tight text-slate-900">
					Issues
				</h2>

				@if (_result.Issues.Count > 0)
				{
					<div class="text-sm text-slate-500">
						Sorted by severity
					</div>
				}
			</div>

			@if (_result.Issues.Count == 0)
			{
				<div class="mt-6 rounded-2xl border border-teal-100 bg-teal-50 p-6 text-teal-900">
					<div class="font-semibold">No issues found.</div>
					<div class="mt-1 text-sm text-teal-800/80">Your CSV looks clean based on the current rules.</div>
				</div>
			}
			else
			{
				<div class="mt-6 overflow-hidden rounded-2xl border border-slate-200 bg-white">
					<div class="overflow-x-auto">
						<table class="min-w-full text-left">
							<thead class="border-b border-slate-200 bg-slate-50">
								<tr>
									<th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600">Severity</th>
									<th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600">Code</th>
									<th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600">Message</th>
									<th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600">Row</th>
									<th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600">Column</th>
								</tr>
							</thead>

							<tbody class="divide-y divide-slate-200">
								@{
									int rowIndex = 0;
								}
								@foreach (var i in PaginatedIssues)
								{
									<tr class="@(rowIndex % 2 == 0 ? "bg-gray-50" : "bg-green-50") hover:bg-gray-200">
									@{
										rowIndex++;
									}
										<td class="px-6 py-4 align-top">
											<span class="@SeverityChipClass(i.Severity)">
												@i.Severity
											</span>
										</td>

										<td class="px-6 py-4 align-top">
											<span class="rounded-lg border border-slate-200 bg-slate-100 px-2 py-1 font-mono text-xs text-slate-700">
												@i.Code
											</span>
										</td>

										<td class="px-6 py-4 align-top">
											<div class="font-medium text-slate-900">
												@i.Message
											</div>

											@if (!string.IsNullOrWhiteSpace(i.Sample))
											{
												<div class="mt-2">
													<div class="mb-1 text-xs font-semibold text-slate-500">Sample</div>
													<code class="block max-w-full overflow-x-auto whitespace-pre rounded-lg border border-slate-200 bg-slate-100 px-3 py-2 font-mono text-xs text-slate-800">
														@i.Sample
													</code>
												</div>
											}
										</td>

										<td class="px-6 py-4 align-top text-slate-700">
											@(i.RowNumber is not null ? i.RowNumber.ToString() : "—")
										</td>

										<td class="px-6 py-4 align-top text-slate-700">
											@(string.IsNullOrWhiteSpace(i.ColumnName) ? "—" : i.ColumnName)
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>

					<!-- Pagination -->
					@if (TotalPages > 1)
					{
						<div class="border-t border-slate-200 bg-slate-50 px-6 py-4">
							<div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
								<div class="flex items-center gap-4">
									<div class="text-sm text-slate-600">
										Showing @(((_currentPage - 1) * _pageSize + 1).ToString("N0")) to @(Math.Min(_currentPage * _pageSize, FilteredIssues.Count()).ToString("N0")) of @(FilteredIssues.Count().ToString("N0")) issues
									</div>

									<div class="flex items-center gap-2">
										<span class="text-xs text-slate-500">Per page:</span>
										@foreach (var size in new[] { 10, 25, 50, 100 })
										{
											var currentSize = size;
											<button type="button"
													class="@(currentSize == _pageSize
														? "rounded-lg border border-teal-600 bg-teal-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition-all hover:bg-teal-700"
														: "rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 transition-all hover:border-teal-300 hover:text-teal-700")"
													@onclick="@(() => ChangePageSize(currentSize))">
												@currentSize
											</button>
										}
									</div>
								</div>

								<div class="flex items-center gap-2">
									<!-- First page -->
									<button type="button"
											class="rounded-lg border border-slate-200 bg-white p-2 text-slate-700 transition-all hover:border-teal-300 hover:text-teal-700 disabled:cursor-not-allowed disabled:opacity-50"
											disabled="@(_currentPage == 1)"
											@onclick="@(() => GoToPage(1))"
											title="First page">
										<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
										</svg>
									</button>

									<!-- Previous page -->
									<button type="button"
											class="rounded-lg border border-slate-200 bg-white p-2 text-slate-700 transition-all hover:border-teal-300 hover:text-teal-700 disabled:cursor-not-allowed disabled:opacity-50"
											disabled="@(_currentPage == 1)"
											@onclick="@(() => GoToPage(_currentPage - 1))"
											title="Previous page">
										<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
										</svg>
									</button>

									<!-- Page numbers -->
									<div class="flex items-center gap-1">
										@{
											var pageNumbers = GetPageNumbers();
											for (int i = 0; i < pageNumbers.Count; i++)
											{
												var pageNum = pageNumbers[i];
												
												if (pageNum == -1)
												{
													<span class="px-2 text-slate-500">...</span>
												}
												else
												{
													var currentPageNum = pageNum;
													<button type="button"
														class="@(currentPageNum == _currentPage
															? "rounded-lg border border-teal-600 bg-teal-600 px-3 py-2 text-sm font-semibold text-white shadow-sm transition-all hover:bg-teal-700"
															: "rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition-all hover:border-teal-300 hover:text-teal-700")"
															@onclick="@(() => GoToPage(currentPageNum))">
														@currentPageNum
													</button>
												}
											}
										}
									</div>

									<!-- Next page -->
									<button type="button"
											class="rounded-lg border border-slate-200 bg-white p-2 text-slate-700 transition-all hover:border-teal-300 hover:text-teal-700 disabled:cursor-not-allowed disabled:opacity-50"
											disabled="@(_currentPage == TotalPages)"
											@onclick="@(() => GoToPage(_currentPage + 1))"
											title="Next page">
										<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
										</svg>
									</button>

									<!-- Last page -->
									<button type="button"
											class="rounded-lg border border-slate-200 bg-white p-2 text-slate-700 transition-all hover:border-teal-300 hover:text-teal-700 disabled:cursor-not-allowed disabled:opacity-50"
											disabled="@(_currentPage == TotalPages)"
											@onclick="@(() => GoToPage(TotalPages))"
											title="Last page">
										<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
										</svg>
									</button>
								</div>
							</div>
						</div>
					}
				</div>
			}
		</div>
	}

</div>

@code {
[Parameter] public string Token { get; set; } = default!;
private CsvAnalysisResult? _result;

private CsvIssueSeverity? _filter;
private DateTimeOffset? expiresUtc = null;

private int _currentPage = 1;
private int _pageSize = 10;

private IEnumerable<CsvIssue> FilteredIssues =>
_result is null
? Array.Empty<CsvIssue>()
: (_filter is null ? _result.Issues : _result.Issues.Where(i => i.Severity == _filter));

private IEnumerable<CsvIssue> PaginatedIssues =>
FilteredIssues
.OrderByDescending(x => x.Severity)
.Skip((_currentPage - 1) * _pageSize)
.Take(_pageSize);

private int TotalPages => FilteredIssues.Any() 
? (int)Math.Ceiling(FilteredIssues.Count() / (double)_pageSize)
: 1;

	protected override void OnParametersSet()
	{
		if (Store.TryGet(Token, out var r))
		{
			expiresUtc = Store.GetExpiresUtc(Token);
			_result = r;
		}
		else
		{
			_result = null;
		}

		// If the current filter no longer exists in the filtered set, leave it as-is;
		// user can Clear.
	}

	private void ToggleFilter(CsvIssueSeverity s)
	{
		_filter = _filter == s ? null : s;
		_currentPage = 1; // Reset to first page when filter changes
	}

	private void ClearFilter()
	{
		_filter = null;
		_currentPage = 1; // Reset to first page when filter is cleared
	}

	private void GoToPage(int page)
	{
		if (page >= 1 && page <= TotalPages)
		{
			_currentPage = page;
		}
	}

	private void ChangePageSize(int newPageSize)
	{
		_pageSize = newPageSize;
		_currentPage = 1; // Reset to first page when page size changes
	}

	private static string FormatBytes(long bytes)
	{
		// Dependency-free formatter
		var units = new[] { "B", "KB", "MB", "GB" };
		double size = bytes;
		int unit = 0;

		while (size >= 1024 && unit < units.Length - 1)
		{
			size /= 1024;
			unit++;
		}

		return unit == 0 ? $"{bytes} {units[unit]}" : $"{size:0.#} {units[unit]}";
	}

	private List<int> GetPageNumbers()
	{
		var pages = new List<int>();
		
		if (TotalPages <= 7)
		{
			// Show all pages if 7 or fewer
			for (int i = 1; i <= TotalPages; i++)
			{
				pages.Add(i);
			}
		}
		else
		{
			// Always show first page
			pages.Add(1);
			
			if (_currentPage <= 4)
			{
				// Near start: 1, 2, 3, 4, 5, ..., last
				for (int i = 2; i <= 5; i++)
				{
					pages.Add(i);
				}
				pages.Add(-1); // ellipsis
				pages.Add(TotalPages);
			}
			else if (_currentPage >= TotalPages - 3)
			{
				// Near end: 1, ..., last-4, last-3, last-2, last-1, last
				pages.Add(-1); // ellipsis
				for (int i = TotalPages - 4; i <= TotalPages; i++)
				{
					pages.Add(i);
				}
			}
			else
			{
				// In middle: 1, ..., current-1, current, current+1, ..., last
				pages.Add(-1); // ellipsis
				for (int i = _currentPage - 1; i <= _currentPage + 1; i++)
				{
					pages.Add(i);
				}
				pages.Add(-1); // ellipsis
				pages.Add(TotalPages);
			}
		}
		
		return pages;
	}

	private static string SeverityChipClass(CsvIssueSeverity severity) => severity switch
	{
		CsvIssueSeverity.Error => "inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-red-50 text-red-700 border border-red-100",
		CsvIssueSeverity.Warning => "inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-amber-50 text-amber-800 border border-amber-100",
		CsvIssueSeverity.Info => "inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-sky-50 text-sky-800 border border-sky-100",
		_ => "inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700 border border-slate-200",
	};
}
