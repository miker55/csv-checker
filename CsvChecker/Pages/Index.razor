@page "/"
@using CsvChecker.Data.Models
@using CsvChecker.Library.Models
@using CvsChecker.Library.Helpers
@using CvsChecker.Library.Services.Interfaces
@inject IJSRuntime JS
@inject ICsvAnalyzer Analyzer
@inject IReportStore Store
@inject ITelemetryService Telemetry
@inject NavigationManager Nav
@implements IDisposable

<!-- HERO -->
<div class="flex flex-col items-center px-4 py-20 text-center sm:pb-1 sm:pt-16">
    <div class="mb-6 inline-flex items-center rounded-full border border-teal-100 bg-teal-50 px-3 py-1 text-xs font-semibold text-teal-700">
        Secure &amp; Private
    </div>

    <h1 class="max-w-5xl text-4xl font-extrabold leading-snug tracking-tight text-slate-900 md:text-6xl md:leading-tight">
        Professional CSV diagnostics <br />
        <span class="text-teal-600">for developers &amp; analysts.</span>
    </h1>

    <p class="mt-6 max-w-2xl text-lg leading-relaxed text-slate-600 sm:text-xl">
        Upload your CSV files to identify structural errors, encoding mismatches, and data integrity issues.
        Instant reports, no data retention.
    </p>

    <div class="mt-10 flex flex-col items-center gap-4">
        <!-- Real file input is hidden; label is the pretty button -->
        <InputFile id="csvUpload"
                   class="hidden"
                   accept=".csv,text/csv"
                   OnChange="OnFileSelected"
                   disabled="@_busy" />

        <label for="csvUpload"
               class="@UploadButtonClass"
               aria-disabled="@_busy">
            @if (_busy)
            {
                <svg class="h-5 w-5 animate-spin text-white" viewBox="0 0 24 24" aria-hidden="true">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <span>Analyzing...</span>
            }
            else
            {
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <span>Upload CSV</span>
            }
        </label>

        <div class="flex items-center gap-4 text-sm font-medium text-slate-400/80">
            <span>No accounts</span>
            <span class="h-1 w-1 rounded-full bg-slate-400/60"></span>
            <span>No AI storage</span>
            <span class="h-1 w-1 rounded-full bg-slate-400/60"></span>
            <span>No file retention</span>
        </div>

    </div>
</div>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="mx-auto mb-12 max-w-md animate-bounce rounded-xl border border-red-100 bg-red-50 p-4 text-center text-sm font-medium text-red-700">
        @_error
    </div>
}

<!-- FEATURES -->
<section class="border-b border-slate-100 bg-white pb-5 pt-20">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-4">

            <div class="group rounded-2xl border border-slate-200/60 bg-slate-50 p-6 transition-colors hover:border-teal-200">
                <div class="mb-6 flex h-12 w-12 items-center justify-center rounded-xl bg-teal-100 text-teal-600 transition-transform group-hover:scale-110">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                </div>
                <h3 class="mb-3 text-xl font-bold text-slate-900">Structural Checks</h3>
                <p class="text-sm leading-relaxed text-slate-600">
                    Verifies column counts, empty rows, and malformed quotes across your entire dataset.
                </p>
            </div>

            <div class="group rounded-2xl border border-slate-200/60 bg-slate-50 p-6 transition-colors hover:border-teal-200">
                <div class="mb-6 flex h-12 w-12 items-center justify-center rounded-xl bg-teal-100 text-teal-600 transition-transform group-hover:scale-110">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                </div>
                <h3 class="mb-3 text-xl font-bold text-slate-900">Encoding &amp; Delimiter</h3>
                <p class="text-sm leading-relaxed text-slate-600">
                    Automatically detects encoding (UTF-8, Latin-1) and identifies the active delimiter.
                </p>
            </div>

            <div class="group rounded-2xl border border-slate-200/60 bg-slate-50 p-6 transition-colors hover:border-teal-200">
                <div class="mb-6 flex h-12 w-12 items-center justify-center rounded-xl bg-teal-100 text-teal-600 transition-transform group-hover:scale-110">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="mb-3 text-xl font-bold text-slate-900">Error Reporting</h3>
                <p class="text-sm leading-relaxed text-slate-600">
                    Get precise row and column location for every error found, categorized by severity.
                </p>
            </div>

            <div class="group rounded-2xl border border-slate-200/60 bg-slate-50 p-6 transition-colors hover:border-teal-200">
                <div class="mb-6 flex h-12 w-12 items-center justify-center rounded-xl bg-teal-100 text-teal-600 transition-transform group-hover:scale-110">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </div>
                <h3 class="mb-3 text-xl font-bold text-slate-900">Diagnostic Export</h3>
                <p class="text-sm leading-relaxed text-slate-600">
                    Download a detailed summary of all identified issues for easy troubleshooting.
                </p>
            </div>

        </div>
    </div>
</section>

@code {
    private bool _busy;
    private string? _error;
    private CancellationTokenSource? _cts;

    // Tailwind-ish CTA button classes from your Hero.tsx
    private string UploadButtonClass =>
        "relative group cursor-pointer flex items-center justify-center gap-3 px-8 py-4 rounded-xl " +
        "bg-teal-600 text-white font-semibold text-lg shadow-lg shadow-teal-600/20 " +
        "hover:bg-teal-700 transition-all active:scale-95 " +
        (_busy ? "opacity-50 cursor-not-allowed pointer-events-none" : "");

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        _error = null;
        _busy = true;

        _cts?.Cancel();
        _cts?.Dispose();
        _cts = new CancellationTokenSource();
        var ct = _cts.Token;
        CsvAnalysisResult? result = null;

        try
        {
            var file = e.File;
            if (file is null)
            {
                _error = "No file selected.";
                await Telemetry.TryTrackAsync(
                    eventType: TelemetryEventType.NoFileSelected
                    , ct: ct
                );
                return;
            }

            if (!file.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
            {
                _error = "Please upload a valid CSV file.";
                await Telemetry.TryTrackAsync(
                    eventType: TelemetryEventType.WrongFileType
                    , message: $"The file type attempted was {Path.GetExtension(file.Name)}."
                    , ct: ct
                );
                return;
            }

            const long maxBytes = 15 * 1024 * 1024; // 15MB
            if (file.Size > maxBytes)
            {
                _error = "File too large for v1 (max 15MB).";
                await Telemetry.TryTrackAsync(
                    eventType: TelemetryEventType.FileTooLarge
                    , message: $"The file size attempted was {file.Size / 1024.0 / 1024.0:F2}MB."
                    , ct: ct
                );
                return;
            }

            try
            {
                await JS.InvokeVoidAsync(
                    "gtag",
                    "event",
                    "csv_uploaded",
                    new
                    {
                        file_size = file.Size
                    }
                );
            }
            catch (Exception ex)
            {
                // Silently ignore GA failures (ad blockers, script not loaded, etc.)
                await Telemetry.TryTrackAsync(
                    eventType: TelemetryEventType.GAFailure
                    , message: ex.Message
                    , ct: ct
                );
            }

            byte[] bytes;
            await using (var stream = file.OpenReadStream(maxAllowedSize: maxBytes))
            using (var ms = new MemoryStream())
            {
                await stream.CopyToAsync(ms, ct);
                bytes = ms.ToArray();
            }

            result = await Analyzer.AnalyzeAsync(file.Name, bytes, ct);
            Store.Put(result);

            await Telemetry.TryTrackAsync(
                eventType: TelemetryEventType.AnalysisCompleted
                , rowCount: result.RowCount
                , columnCount: result.ColumnCount
                , fileSizeBytes: result.FileSizeBytes
                , issueCount: result.Issues.Count
                , ct: ct
            );

            try
            {
                await JS.InvokeVoidAsync(
                    "gtag",
                    "event",
                    "analysis_complete",
                    new
                    {
                        row_count = result.RowCount,
                        issue_count = result.Issues.Count
                    }
                );
            }
            catch
            {
                // ignore GA errors here
            }
        
            Nav.NavigateTo($"/report/{result.Token}");
        }
        catch (Exception ex)
        {
            _error = "Failed to analyze CSV. Please try again.";

            await Telemetry.TryTrackAsync(
                eventType: TelemetryEventType.AnalysisFailed
                , message: ex.Message
                , rowCount: result?.RowCount
                , columnCount: result?.ColumnCount
                , fileSizeBytes: result?.FileSizeBytes
                , issueCount: result?.Issues.Count
                , ct: ct
            );
        }
        finally
        {
            _busy = false;
        }
    }
}
